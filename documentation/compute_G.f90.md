# `compute_G.f90`

## Overview

The `cmpt_G.f90` module is responsible for calculating the lattice correspondence tensor, denoted as **G**, for each atom within an atomic configuration. This tensor quantifies the local elastic deformation around an atom relative to a reference (undeformed) state. The implementation primarily follows the methodology outlined by C.S. Hartley and Y. Mishin in Acta Materialia 53 (2005) 1313-1321.

The module can operate with different types of reference systems:
1.  A full reference system: An undeformed crystal structure with a one-to-one correspondence of atoms to the analyzed system.
2.  A unit cell: A smaller, perfect unit cell of the material, from which reference atomic environments are derived.
3.  No explicit reference: In this case, "average" reference environments are constructed on-the-fly from the local atomic environments within the analyzed system itself.

The calculation involves identifying neighboring atoms for each atom in both the reference and analyzed configurations, establishing a correspondence between these neighbor sets, and then solving for the **G** tensor that best maps the reference neighbor vectors to the deformed neighbor vectors.

## Key Components

- **`MODULE cmpt_G`**: The main module encapsulating the functionality.
- **`SUBROUTINE COMPUTE_G(H1, P1, H2, P2, params, NeighList1, NeighList2, Pref, siteindex, G)`**: This is the core subroutine that performs the G tensor calculation.
    - It initializes and potentially adjusts parameters for neighbor finding (`cutoff`, `NNmin`, `NeighFactor`) and neighbor vector comparison (`theta_max`), including reading user overrides from an `atomsk.conf` or `atomsk.ini` file.
    - Determines the nature of the reference system (`P1`, `H1`) relative to the analyzed system (`P2`, `H2`).
    - Constructs neighbor lists (`NeighList1` for the reference system, `NeighList2` for the analyzed system) if they are not provided as input. This uses the `NEIGHBOR_LIST` and `NEIGHBOR_POS` subroutines.
    - If a full reference system isn't available, it generates reference atomic environments (`Pref`) and site indices (`siteindex`) using the `AVG_ENV` subroutine (if no reference at all) or by processing the provided unit cell.
    - For each atom in the analyzed system (`P2`):
        - It identifies the set of reference neighbor vectors (**P_neigh**).
        - It identifies the set of actual, deformed neighbor vectors (**Q_neigh**).
        - It establishes a reliable correspondence between these two sets of vectors by considering distances and angles, filtering out pairs where the angle exceeds `theta_max`.
        - It computes the Moore-Penrose pseudo-inverse of the matrix formed by `Q_neigh` vectors (denoted **Q+**) using the LAPACK routine `DGELSS`.
        - The lattice correspondence tensor **G** for the current atom is then calculated as **G = Q+ * P_matrix**, where **P_matrix** is formed by the corresponding reference neighbor vectors.
    - The resulting **G** tensors for all atoms, along with other generated data like `Pref` and `siteindex`, are returned.

## Important Variables/Constants

*   **Input Arguments:**
    - **`H1 (REAL(dp), DIMENSION(3,3))`**: Cell vectors of the reference system (system 1).
    - **`P1 (REAL(dp), DIMENSION(:,:), ALLOCATABLE, TARGET)`**: Atomic positions and types for system 1. Can be empty or a unit cell.
    - **`H2 (REAL(dp), DIMENSION(3,3))`**: Cell vectors of the analyzed system (system 2).
    - **`P2 (REAL(dp), DIMENSION(:,:), ALLOCATABLE, TARGET)`**: Atomic positions and types for system 2.

*   **Input/Output Arguments:**
    - **`params (REAL(dp), DIMENSION(4))`**: An array to store/return parameters used: `cutoff`, `NNmin`, `NeighFactor`, `theta_max`.
    - **`NeighList1 (INTEGER, DIMENSION(:,:), ALLOCATABLE)`**: Neighbor list for system 1. Can be input if pre-calculated, or output if calculated by the routine.
    - **`NeighList2 (INTEGER, DIMENSION(:,:), ALLOCATABLE)`**: Neighbor list for system 2. Can be input or output.
    - **`Pref (REAL(dp), DIMENSION(:,:,:), ALLOCATABLE)`**: Array storing reference atomic environments. Output if generated by the routine. Each `Pref(i,:,:)` defines a reference site `i`, with `Pref(i,1,1:6)` storing central atom info (pos, type, count, num_neighbors) and `Pref(i,2:N_neigh+1,1:4)` storing neighbor relative positions and types.
    - **`siteindex (INTEGER, DIMENSION(:), ALLOCATABLE)`**: For each atom in `P2`, stores the index of the reference environment in `Pref` it corresponds to. Output if generated.

*   **Output Arguments:**
    - **`G (REAL(dp), DIMENSION(:,:,:), ALLOCATABLE)`**: The primary output: an array of size `(N_atoms_in_P2, 3, 3)` containing the computed lattice correspondence tensor **G** for each atom in system 2.

*   **Key Internal Parameters & Variables:**
    - **`cutoff (REAL(dp))`**: Cutoff radius for initial neighbor search.
    - **`NNmin (INTEGER)`**: Minimum number of neighbors to consider for defining a local environment.
    - **`NeighFactor (REAL(dp))`**: A factor applied to the distance of the `NNmin`-th neighbor to refine the cutoff for reliable neighbors. Default: 1.1.
    - **`theta_max (REAL(dp))`**: Maximum allowed angle (in radians) between a reference neighbor vector and its corresponding deformed neighbor vector for the pair to be included in the G tensor calculation. Default: 27 degrees.
    - **`P_neigh, Q_neigh (REAL(dp), DIMENSION(:,:), ALLOCATABLE)`**: Temporary arrays holding relative positions of neighbors for an atom in the reference and deformed configurations, respectively.
    - **`P_matrix, Q_matrix (REAL(dp), DIMENSION(:,:), ALLOCATABLE)`**: Matrices formed from the selected, corresponding neighbor vectors for input into the G tensor equation.
    - **`Q_plus (REAL(dp), DIMENSION(:,:), ALLOCATABLE)`**: The pseudo-inverse of `Q_matrix`.

## Usage Examples

This subroutine is typically called internally within Atomsk when a user requests the calculation of the Nye tensor or related local crystallographic analyses. A direct Fortran call would look like this:

```fortran
PROGRAM test_compute_g
  USE cmpt_G
  USE atoms_module ! Assuming H1,P1,H2,P2 are defined and filled here
  IMPLICIT NONE

  REAL(dp), DIMENSION(3,3) :: H1, H2
  REAL(dp), DIMENSION(:,:), ALLOCATABLE :: P1, P2
  REAL(dp), DIMENSION(4) :: params_g
  INTEGER, DIMENSION(:,:), ALLOCATABLE :: nl1, nl2
  REAL(dp), DIMENSION(:,:,:), ALLOCATABLE :: pref_g, g_tensor

  INTEGER, DIMENSION(:), ALLOCATABLE :: s_index

  ! ... code to initialize H1, P1, H2, P2 ...
  ! P1 might be unallocated if no explicit reference is used,
  ! or contain unit cell data.

  ! Initialize parameters (optional, can be set by COMPUTE_G or from config file)
  ! params_g(1) = cutoff, params_g(2) = NNmin,
  ! params_g(3) = NeighFactor, params_g(4) = theta_max (radians)

  CALL COMPUTE_G(H1, P1, H2, P2, params_g, nl1, nl2, pref_g, s_index, g_tensor)

  IF (ALLOCATED(g_tensor)) THEN
    PRINT *, "G tensor for atom 1:"
    PRINT *, g_tensor(1,:,:)
    ! ... process g_tensor, pref_g, s_index ...
  ELSE
    PRINT *, "G tensor calculation failed or produced no output."
  END IF

  ! ... deallocate arrays ...

END PROGRAM test_compute_g
```

## Dependencies and Interactions

- **`comv`**: Used for global variables like `verbosity`, error (`nerr`), and warning (`nwarn`) counters.
- **`subroutines`**: Relies on various utility subroutines for tasks like:
    - `ATOMSPECIES`: Converting atomic numbers to species symbols (for debug output).
    - `BUBBLESORT`: Sorting neighbor lists by distance.
    - `ANGVEC`: Calculating the angle between two vectors.
    - `VECLENGTH`: Calculating the length of a vector.
- **`strings`**: Uses string manipulation functions like `StrDnCase`, `TRIM`, `ADJUSTL` for parsing configuration files.
- **`messages`**: Uses `ATOMSK_MSG` for standardized output messages, warnings, and errors.
- **`neighbors`**: Depends on `NEIGHBOR_LIST` (to get neighbor indices) and `NEIGHBOR_POS` (to get neighbor Cartesian coordinates and distances).
- **`avgenv`**: If no explicit reference system or only a unit cell is provided, `AVG_ENV` is called to generate average reference atomic environments from the input system (`P2`).
- **LAPACK Library**: Critically depends on the `DGELSS` routine from LAPACK for solving the linear least-squares problem to find the pseudo-inverse of the neighbor matrix **Q**, which is essential for calculating **G**.
- **File System**:
    - Reads `atomsk.conf` (Unix/Linux) or `atomsk.ini` (Windows) to check for user-defined parameters (`nye cutoff`, `nye nnmin`, `nye neighfactor`, `nye theta_max`) that override default values.
    - If `verbosity == 4` (debug mode), it may write out files like `atomsk_site_i.xyz` (visualizing reference environments) and `atomsk_siteindex.txt`.
- **Parallelism**: The main loop over atoms for computing **G** is parallelized using OpenMP directives (`!$OMP PARALLEL DO`).
